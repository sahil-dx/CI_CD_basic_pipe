name: Node CI/CD Clean Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: CI check
        run: npm install

      - name: Deploy to EC2 (with rollback & clean logs)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e

            APP=/var/www/node-app
            RELEASE=$APP/releases/$(date +%Y%m%d%H%M%S)
            CURRENT=$APP/current
            PREVIOUS=$(readlink $CURRENT || true)

            mkdir -p $APP/releases

            git clone https://github.com/sahil-dx/CI_CD_basic_pipe.git $RELEASE

            cd $RELEASE
            npm install

            ln -sfn $RELEASE $CURRENT

            pm2 delete node-app || true
            cd $CURRENT
            pm2 start index.js --name node-app
            pm2 save

            sleep 5

            # üîç HEALTH CHECK (ONLY ERROR LOGS)
            if ! curl -sf http://localhost:5000 > /dev/null; then
              echo "‚ùå Deployment failed ‚Äî Application error only:"
              echo "------------------------------------------------"

              tail -n 30 ~/.pm2/logs/node-app-error.log || echo "No error log found"

              echo "------------------------------------------------"
              echo "Rolling back to previous stable version..."

              pm2 delete node-app || true

              if [ -n "$PREVIOUS" ]; then
                ln -sfn $PREVIOUS $CURRENT
                cd $CURRENT
                pm2 start index.js --name node-app
                pm2 save
              fi

              exit 1
            fi

            echo "‚úÖ Deployment successful"
